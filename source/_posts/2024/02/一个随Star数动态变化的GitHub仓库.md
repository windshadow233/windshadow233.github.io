---
title: ä¸€ä¸ªéšStaræ•°åŠ¨æ€å˜åŒ–çš„GitHubä»“åº“
id: 9506
date: 2024-02-23 18:00:43
categories: [æ‚è¶£]
tags: ['API GateWay', 'AWS Lambda', 'GitHub API', 'Python', 'Webhook']
cover: https://api.star-history.com/svg?repos=windshadow233/This-Repo-Has-0-Stars&type=Date
disableNunjucks: false
swiper_index: 1
description: ä¸€ä¸ªæœ‰æ„æ€çš„GitHubä»“åº“
---

å‡ å¹´å‰æ›¾çœ‹åˆ°è¿‡@iBugå¤§ä½¬çš„[ä¸€ä¸ªGitHubä»“åº“](https://github.com/iBug/This-Repo-Has-0-Stars)ï¼Œè¿™ä¸ªä»“åº“çš„åå­—ä»¥åŠæè¿°ä¼šå®æ—¶æ˜¾ç¤ºå½“å‰çš„Staræ•°é‡ï¼Œä»¤å½“æ—¶çš„æˆ‘è§‰å¾—éå¸¸æœ‰æ„æ€ï¼Œä¸è¿‡é‚£ä¼šæˆ‘å¹¶æ²¡æœ‰å»ç ”ç©¶åŸç†ã€‚å‡ å¹´è¿‡å»äº†ï¼Œå´ä¸çŸ¥æ˜¨å¤©ä¸ºå•¥çªç„¶æƒ³åˆ°ï¼Œäºæ˜¯è¯»äº†ä¸€ä¸‹å¤§ä½¬çš„[æ–‡ç« ](https://ibug.io/p/41)ï¼Œè¯•ç€å¤ç°äº†ä¸€ä¸‹ã€‚

æˆ‘å¤ç°çš„ä»“åº“é“¾æ¥å¦‚ä¸‹ï¼š

{% link This Repo Has 0 Stars,GitHub,https://github.com/windshadow233/This-Repo-Has-0-Stars %}

æœ‹å‹ä»¬å¯ä»¥è¿›å»ç‚¹ä¸ªstarçœ‹çœ‹æ•ˆæœï½~~ï¼ˆæ²¡æƒ³åˆ°æˆ‘ç¬¬ä¸€æ¬¡éª—starç«Ÿæ˜¯ä¸ºè¿™ï¼‰~~

![](https://api.star-history.com/svg?repos=windshadow233/This-Repo-Has-0-Stars&type=Date)


---

é¡¹ç›®å¾ˆç®€å•ï¼Œä½†å…¶èƒŒåçš„åŸç†è¦†ç›–äº†ä¸€äº›æˆ‘ä¹‹å‰æ²¡æœ‰æ¥è§¦è¿‡çš„ä¸œè¥¿ï¼Œä¾‹å¦‚GitHub REST APIã€Webhookï¼ˆè¿™ä¸ªå€’æ˜¯åœ¨åštelegram botçš„æ—¶å€™æ¥è§¦è¿‡ï¼‰ã€AWS Lambdaç­‰ã€‚å¦‚æœèƒ½ç†Ÿç»ƒåˆ©ç”¨ï¼Œæ„Ÿè§‰ä¼šæ˜¯ä¸ªå¾ˆé«˜æ•ˆã€å¾ˆæ–¹ä¾¿çš„è¾…åŠ©å·¥å…·ã€‚ç”±äºiBugå¤§ä½¬çš„æ–‡ç« çœç•¥äº†å¥½å¤šã€Œæœ‰æ‰‹å°±è¡Œã€ä½†æˆ‘ä¸ä¼šçš„å†…å®¹ï¼Œæ‰€ä»¥åœ¨è¿‡ç¨‹ä¸­è¸©äº†ä¸€äº›å‘ï¼Œå› æ­¤æˆ‘æ¥æ°´ç¯‡æ–‡ç« ï¼Œæ›´è¯¦ç»†åœ°è®°å½•ä¸€ä¸‹ã€‚


## å®ç°åŸç†


è¿™ä¸ªä¸œè¥¿çš„åŸç†å…¶å®å°±æ˜¯ï¼Œä½¿ç”¨GitHubè‡ªå¸¦çš„Webhookï¼Œç›‘å¬ä»“åº“çš„å„ç§äº‹ä»¶ï¼ˆå¦‚æœ¬ä¾‹ç›‘å¬çš„æ˜¯ã€ŒStarã€äº‹ä»¶ï¼‰ï¼Œä¸€æ—¦äº‹ä»¶å‘ç”Ÿï¼Œåˆ™è‡ªåŠ¨æ¨é€æ¶ˆæ¯åˆ°æŒ‡å®šçš„URLï¼Œé€šè¿‡URLèƒŒåçš„ä»£ç æ¥è°ƒç”¨GitHub REST APIï¼Œä»è€Œå®ç°åœ¨Staræ•°æ›´æ–°æ—¶è‡ªåŠ¨ä¿®æ”¹GitHub repoåã€‚æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰è¯¥URLï¼Œä¸ºé™ä½å¤æ‚åº¦ã€æå‡ç»´æŠ¤çš„ä¾¿åˆ©æ€§ï¼Œé€‰æ‹©ä½¿ç”¨AWS Lambdaè¿™ç§Serverlessçš„æœåŠ¡ã€‚


## åˆ›å»ºGitHub Repoå¹¶æ·»åŠ Webhook


ç¬¬ä¸€æ­¥è‡ªç„¶æ˜¯éœ€è¦æŠŠä»“åº“å»ºç«‹èµ·æ¥ï¼Œå¯ä»¥éšä¾¿èµ·ä¸ªåï¼Œä¾‹å¦‚â€œThis-Repo-Has-0-Starsâ€ã€‚ç„¶åå‰å¾€ä»“åº“çš„ã€ŒSettings->Webhooksã€æ ‡ç­¾ï¼Œç‚¹å‡»ã€ŒAdd webhookã€ã€‚


- Payload URLï¼šæ¨é€æ¶ˆæ¯çš„ç›®çš„åœ°å€ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜æ²¡æœ‰ç”³è¯·AWSçš„APIï¼Œå…ˆä¸ç®¡ã€‚
- Content typeï¼šæˆ‘æ¯”è¾ƒå–œæ¬¢ç”¨JSONï¼Œäºæ˜¯æˆ‘é€‰æ‹©äº†ã€Œapplication/jsonã€ï¼Œå®é™…ä¹Ÿå°±æ˜¯å†™ä»£ç çš„æ—¶å€™ç•¥æœ‰åŒºåˆ«ã€‚
- Secretï¼šWebhookçš„ç­¾åå­—ç¬¦ä¸²ï¼Œå¯ç”¨æ¥éªŒç­¾ï¼Œå¯ä»¥ä¸å¡«ï¼Œä¸è¿‡è¿˜æ˜¯å»ºè®®ç”¨å¯†ç ç”Ÿæˆå™¨æ¥ç”Ÿæˆä¸€ä¸ªã€‚
- Which events would you like to trigger this webhook? ç”±äºæˆ‘ä»¬çš„ç›®çš„æ˜¯ç›‘å¬Staräº‹ä»¶ï¼Œå› æ­¤è¿™é‡Œé€‰æ‹©ã€ŒLet me select individual eventsã€ï¼Œç„¶ååœ¨ä¸‹é¢çš„åˆ—è¡¨ä¸­å–æ¶ˆå‹¾é€‰ã€ŒPushesã€ï¼Œå‹¾é€‰ã€ŒStarsã€ã€‚

äºæ˜¯è¿˜å‰©Payload URLæ²¡æœ‰é…ç½®ï¼Œæš‚æ—¶å…ˆæ”¾ç€ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥ã€‚


## åˆ›å»ºGitHub Access Token


ä¸ºé€šè¿‡GitHub REST APIä¿®æ”¹ä»“åº“åï¼Œéœ€è¦æä¸€ä¸ªtokenç”¨æ¥é‰´æƒã€‚[æ­¤å¤„å‰å¾€tokenç”³è¯·é¡µé¢](https://github.com/settings/tokens)

![](https://fastly.jsdelivr.net/gh/windshadow233/BlogStorage@files/png/0b842b41077a21768b19fdc4c6077292.png)
å¦‚ä¸Šï¼Œç”³è¯·ä¸€ä¸ªç”¨äºç®¡ç†repoçš„tokenï¼Œå°†å…¶ä¿å­˜ä¸‹æ¥ã€‚


## åˆ›å»ºAWS Lambdaå‡½æ•°


ç”±äºä¹‹å‰å‘ç”Ÿè¿‡ä¸€æ¬¡å› ä¸äº†è§£AWSå¹³å°çš„è®¡è´¹æ–¹å¼è€Œç™½ç™½æµªè´¹äº†100å¤šrmbçš„æƒ¨ç—›ç»å†ï¼Œäºæ˜¯è¿™æ¬¡æˆ‘æå‰æ‘¸æ¸…äº†å¥—è·¯ï¼š

![](https://fastly.jsdelivr.net/gh/windshadow233/BlogStorage@files/png/b16be8fe50b9ab5a3604ba02f66e490c.png)
ä½œä¸ºä¸€ä¸ªå¨±ä¹é¡¹ç›®è‚¯å®šç¨³ç¨³å¤Ÿç”¨äº†ã€‚


å‰å¾€[AWSæ§åˆ¶å°](https://console.aws.amazon.com/)ï¼Œåœ¨ã€ŒæœåŠ¡ã€ä¸­æœç´¢lambdaï¼š

![](https://fastly.jsdelivr.net/gh/windshadow233/BlogStorage@files/png/fc6f1e676e40023f54d6e7325436c326.png)
åˆ›å»ºä¸€ä¸ªlambdaå‡½æ•°ï¼Œå¹¶é€‰æ‹©ä½ å–œæ¬¢çš„ç¼–ç¨‹è¯­è¨€<s>ï¼ˆPython 3.8ï¼‰</s>ï¼š

![](https://fastly.jsdelivr.net/gh/windshadow233/BlogStorage@files/png/141591ad60ec1fdd621d28e451bd0d1b.png)
ç‚¹ã€Œåˆ›å»ºå‡½æ•°ã€å³å¯ã€‚è¿›å…¥ä»£ç é¡µï¼Œå‘ç°å®ƒä¸ºæˆ‘ä»¬æä¾›äº†æœ€åŸºç¡€çš„ï¼ˆPythonï¼‰ä»£ç ï¼š

```python
import json

def lambda_handler(event, context):
    # TODO implement
    return {
        'statusCode': 200,
        'body': json.dumps('Hello from Lambda!')
    }

```

ä¸è¿‡å®ƒå¥½åƒå¹¶ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œè€Œæ˜¯è¦é€šè¿‡AWSå…¶ä»–åœ°æ–¹çš„æ¥å£æ¥è°ƒç”¨ï¼Œè¿™ä¸ªä¸œè¥¿ç§°ä¸º[AWS API Gateway](https://console.aws.amazon.com/apigateway/main)ã€‚

## é…ç½®AWS API Gateway

![](https://fastly.jsdelivr.net/gh/windshadow233/BlogStorage@files/png/2a2cd66dca325096ccd7276f47b61194.png)
è¿™ç©æ„åˆ™æ˜¯æ”¶è´¹çš„ï¼Œä¸è¿‡å¾ˆä¾¿å®œï¼Œä¸å…¬å¼€æ¥å£çš„è¯åº”è¯¥å¼€é”€ä¸å¤§ã€‚


ç‚¹å‡»ã€Œåˆ›å»ºAPIã€ï¼Œå¹¶é€‰æ‹©ã€ŒHTTP APIã€ï¼š

![](https://fastly.jsdelivr.net/gh/windshadow233/BlogStorage@files/png/2668837da3012db8132b8b54eca98177.png)
æ·»åŠ ä¸€ä¸ªLambdaé›†æˆï¼Œå¹¶é€‰æ‹©å‰é¢åˆ›å»ºçš„Lambdaå‡½æ•°ï¼Œæœ€åç‚¹ã€Œä¸‹ä¸€æ­¥ã€ï¼š

![](https://fastly.jsdelivr.net/gh/windshadow233/BlogStorage@files/png/cd50a23967f4337dc5a68819594e0aed.png)
é…ç½®è·¯ç”±ï¼ŒæŒ‰iBugå¤§ä½¬[æ‰€è¯´](https://ibug.io/cn/2021/02/github-webhook-on-aws-lambda/#api-gateway)ï¼Œå¡«å†™$defaultï¼š

![](https://fastly.jsdelivr.net/gh/windshadow233/BlogStorage@files/png/1a33ef7f7dbe11a28a33701994de02ac.png)
è¿™æ ·ä¾¿åˆ›å»ºå¥½äº†ä¸€ä¸ªHTTP APIï¼ŒAWSä¸ºå…¶åˆ†é…äº†ä¸€ä¸ªIDï¼Œå³ä¸‹é¢çš„87z7tufbtkï¼š

![](https://fastly.jsdelivr.net/gh/windshadow233/BlogStorage@files/png/fbe85d2db6553829ed92f5a0d3fe52b6.png)
å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹æ³•ç®€å•æµ‹è¯•ä¸€ä¸‹ï¼š

```bash
$ curl https://87z7tufbtk.execute-api.us-east-1.amazonaws.com/
"Hello from Lambda!"%
```

è¿™ä¸²URLï¼š`https://87z7tufbtk.execute-api.us-east-1.amazonaws.com/` ä¹Ÿæ­£æ˜¯å‰é¢åˆ›å»ºwebhookæ—¶ç•™ç€æ²¡å¡«çš„é‚£ä¸ªPayload URLã€‚

## ç¼–å†™Lambdaå‡½æ•°


åˆšåˆšçš„æ¥å£æµ‹è¯•è¯´æ˜Lambdaå‡½æ•°å·²ç»workäº†ï¼Œäºæ˜¯éœ€è¦ç¼–å†™ä¸€ä¸‹è¿™ä¸ªLambdaå‡½æ•°ä»¥ä½¿å…¶è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœâ€”â€”è·å–åˆ°repoçš„staræ•°ï¼Œç„¶åæŠŠå®ƒçš„åå­—ã€æè¿°æ”¹äº†ã€‚è¿™é‡Œçš„å‚æ•°ç ”ç©¶ç­‰è¿‡ç¨‹å»ºè®®ç›´æ¥é˜…è¯»[iBugå¤§ä½¬çš„æ–‡ç« ](https://ibug.io/cn/2021/02/github-webhook-on-aws-lambda/#lambda-code)ï¼Œæˆ‘å°±ç›´æ¥è´´å®Œæ•´çš„ä»£ç äº†ï¼ˆæ­¤ä»£ç ä¿®æ”¹è‡ªiBugå¤§ä½¬çš„ä»£ç ï¼Œä¹Ÿå¯ä»¥åœ¨[æˆ‘çš„ä»“åº“](https://github.com/windshadow233/This-Repo-Has-0-Stars)é‡Œçœ‹åˆ°ï¼‰

### ä»£ç 

```python
import base64
import hashlib
import hmac
import os
import json

import requests


GITHUB_TOKEN = os.environ.get('GITHUB_TOKEN')
SECRET = os.environ.get('SECRET')


def lambda_handler(event, context):
    path = event['rawPath']
    if 'body' in event:
        if event['isBase64Encoded']:
            body = base64.b64decode(event['body'])
        else:
            body = event['body'].encode()
    else:
        body = b""
    signature = event['headers']['x-hub-signature-256'].split("=")[1]
    hashsum = hmac.new(SECRET.encode(), msg=body, digestmod=hashlib.sha256).hexdigest()
    if hashsum != signature:
        return {
            'statusCode': 401,
            'body': 'Bad signature'
        }
    if path == "/":
        # https://docs.github.com/en/developers/webhooks-and-events/webhook-events-and-payloads#star
        payload = json.loads(body)
        repository = payload['repository']
        repository_url = repository['url']
        stars = repository['stargazers_count']

        new_name = f"This-Repo-Has-{stars}-Star{'s' if stars != 1 else ''}"
        new_description = f"Thanks for stopping by! This repository now has {stars} star{'s' if stars != 1 else ''}~ğŸŒŸğŸŒŸğŸŒŸ"
        headers = {'Authorization': f"Bearer {GITHUB_TOKEN}"}
        data = {
            'name': new_name,
            'description': new_description
        }
        response = requests.patch(repository_url, headers=headers, json=data)
        return {'statusCode': response.status_code, 'body': "OK"}
    else:
        return {'statusCode': 404, 'body': ""}
```

### é…ç½®ç¯å¢ƒå˜é‡


æ³¨æ„åˆ°ä»£ç æœ€å‰é¢è¯»å–äº†ä¿©ç¯å¢ƒå˜é‡ï¼ŒGITHUB_TOKENå’ŒSECRETåˆ†åˆ«æ˜¯å‰é¢ç”³è¯·çš„GitHub Access Tokenå’ŒWebhook Secretå­—ç¬¦ä¸²ï¼Œä¸ºåœ¨ä»£ç ä¸­è·å–ï¼Œéœ€è¦å°†å…¶è®¾ç½®åœ¨Lambdaå‡½æ•°çš„ã€Œé…ç½®->ç¯å¢ƒå˜é‡ã€æ ‡ç­¾æ ä¸‹ï¼š

![](https://fastly.jsdelivr.net/gh/windshadow233/BlogStorage@files/png/557096d4f67f0052976cbd52facca6d6.png)
### æ·»åŠ ç¬¬ä¸‰æ–¹åº“


è®¾ç½®å®Œä¸Šé¢çš„å†…å®¹åï¼Œæˆ‘ç»™ä»“åº“ç‚¹äº†ä¸ªstarï¼Œç„¶è€Œ

![](https://fastly.jsdelivr.net/gh/windshadow233/BlogStorage@files/png/5385911526e61a25e9cd3b8d833ed57b.png)
debugäº†åŠå¤©å‘ç°åŸæ¥æ˜¯Lambdaå‡½æ•°çš„Python 3.8ç¯å¢ƒæ²¡æœ‰ç¬¬ä¸‰æ–¹åº“ï¼Œä¾‹å¦‚requestsï¼Œäºæ˜¯è¦æƒ³åŠæ³•æŠŠç¬¬ä¸‰æ–¹åº“é›†æˆè¿›å»ã€‚


ç ”ç©¶äº†ä¸€ä¼šï¼Œå‘ç°Lambdaæä¾›ä¸€ç§å«ã€Œå±‚ã€çš„åŠŸèƒ½ï¼š

![](https://fastly.jsdelivr.net/gh/windshadow233/BlogStorage@files/png/584646ce929f46a1f6c31e942b764a3d.png)
é€šè¿‡æ·»åŠ ã€Œå±‚ã€ï¼Œå¯ä»¥å°†ç¬¬ä¸‰æ–¹åº“æ‰“åŒ…æ·»åŠ è¿›å»ã€‚ä¸‹é¢å…ˆæ‰“åŒ…ç¬¬ä¸‰æ–¹åº“ã€‚


åœ¨æœ¬åœ°çš„Python 3.8ç¯å¢ƒä¸­æ‰§è¡Œä¸‹è¿°å‘½ä»¤ï¼Œå¾—åˆ°pythonç›®å½•ï¼Œå°†è¯¥ç›®å½•æ‰“åŒ…ä¸ºpython.zip

```bash
pip install --target ./python requests urllib3==1.26.16
```

ç„¶åã€Œåˆ›å»ºå±‚ã€ï¼š

![](https://fastly.jsdelivr.net/gh/windshadow233/BlogStorage@files/png/8178a6c7d9f32019c89b8f0e1c3a6dbd.png)
åç§°å¯ä»¥éšæ„å¡«å†™ï¼Œç‚¹å‡»ã€Œä¸Šä¼ ã€æŒ‰é’®ï¼Œå°†å‰é¢çš„python.zipä¸Šä¼ ï¼Œé€‰æ‹©å‡ ä¸ªåˆé€‚çš„è¿è¡Œæ—¶ï¼Œç‚¹å‡»ã€Œåˆ›å»ºã€ã€‚


å›åˆ°Lambdaçš„ã€Œä»£ç ã€éƒ¨åˆ†ï¼Œæ‹‰åˆ°æœ€åº•ä¸‹ï¼Œæœ‰ä¸€å—ã€Œå±‚ã€åŒºåŸŸï¼š

![](https://fastly.jsdelivr.net/gh/windshadow233/BlogStorage@files/png/b9d8d8e1ba41b8aef4a78192b751ccb3.png)
æˆ‘ä»¬åœ¨è¿™é‡Œæ·»åŠ åˆšåˆšåˆ›å»ºçš„å±‚ï¼Œå³å¯è®©Pythonç¯å¢ƒæ‹¥æœ‰requestsã€‚

![](https://fastly.jsdelivr.net/gh/windshadow233/BlogStorage@files/png/b3e4598f853c256a1a6f3021bcdda2e8.png)


---

## æœ€å


åˆ°äº†è¿™é‡Œï¼Œè¿™ä¸ªä¼šè‡ªåŠ¨éšstaræ•°æ›´æ–°åå­—å’Œæè¿°çš„repoå°±å·²ç»åšå®Œäº†ã€‚ä¸è¿‡å…¶ä¸­æ‰€ç”¨åˆ°çš„æŠ€æœ¯ï¼Œä»æœ‰å¾ˆå¤§çš„åº”ç”¨ç©ºé—´å°šæœªç ”ç©¶ï¼Œã€Œä¸‹æ¬¡ä¸€å®šã€æ‰¾ä¸ªæœºä¼šå¤šç©ç©ï¼
